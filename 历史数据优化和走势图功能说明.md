# å†å²æ•°æ®ä¼˜åŒ–å’Œèµ°åŠ¿å›¾åŠŸèƒ½è¯´æ˜

## ğŸ“‹ ç›®å½•
1. [å†å²æ•°æ®è·å–ä¼˜åŒ–](#å†å²æ•°æ®è·å–ä¼˜åŒ–)
2. [èµ°åŠ¿å›¾åŠŸèƒ½](#èµ°åŠ¿å›¾åŠŸèƒ½)
3. [APIæ–‡æ¡£](#apiæ–‡æ¡£)
4. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)

---

## ğŸš€ å†å²æ•°æ®è·å–ä¼˜åŒ–

### é—®é¢˜1ï¼šå¦‚ä½•ä¸€æ¬¡æ€§è·å–æ‰€æœ‰å†å²æ•°æ®

**è§£å†³æ–¹æ¡ˆ**ï¼šæé«˜æ‰¹é‡è·å–ä¸Šé™

- **ä¿®æ”¹å‰**ï¼šæœ€å¤š500æœŸ
- **ä¿®æ”¹å**ï¼šæœ€å¤š2000æœŸ

```go
if count > 2000 {
    count = 2000 // æœ€å¤š2000æœŸ
}
```

**ä½¿ç”¨æ–¹æ³•**ï¼š
```
POST /api/shuangseqiu/fetch-history?count=2000
POST /api/daletou/fetch-history?count=2000
```

### é—®é¢˜2ï¼šå‰ç«¯ç‚¹å‡»è·å–å†å²æ•°æ®æ—¶æ¥å£è¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**ï¼šå¼‚æ­¥ä»»åŠ¡å¤„ç†

#### 2.1 ä»»åŠ¡ç®¡ç†å™¨

åˆ›å»ºäº† `TaskManager` æ¥ç®¡ç†å¼‚æ­¥ä»»åŠ¡ï¼š

**åŠŸèƒ½ç‰¹ç‚¹**ï¼š
- âœ… ä»»åŠ¡çŠ¶æ€è¿½è¸ªï¼ˆpending, running, completed, failedï¼‰
- âœ… è¿›åº¦å®æ—¶æ›´æ–°
- âœ… ä»»åŠ¡ç»“æœå­˜å‚¨
- âœ… è‡ªåŠ¨æ¸…ç†è¿‡æœŸä»»åŠ¡ï¼ˆ1å°æ—¶åï¼‰

**ä»»åŠ¡çŠ¶æ€**ï¼š
```go
type TaskInfo struct {
    ID          string      `json:"id"`           // ä»»åŠ¡ID
    Type        string      `json:"type"`         // shuangseqiu/daletou
    Status      TaskStatus  `json:"status"`       // çŠ¶æ€
    Progress    int         `json:"progress"`     // è¿›åº¦(%)
    Total       int         `json:"total"`        // æ€»æ•°
    Success     int         `json:"success"`      // æˆåŠŸ
    Skipped     int         `json:"skipped"`      // è·³è¿‡
    Failed      int         `json:"failed"`       // å¤±è´¥
    Message     string      `json:"message"`      // æ¶ˆæ¯
    StartTime   time.Time   `json:"start_time"`   // å¼€å§‹æ—¶é—´
    EndTime     *time.Time  `json:"end_time"`     // ç»“æŸæ—¶é—´
    Result      interface{} `json:"result"`       // ç»“æœ
}
```

#### 2.2 è‡ªåŠ¨å¼‚æ­¥å¤„ç†

**æ™ºèƒ½åˆ¤æ–­**ï¼š
- æ•°é‡ â‰¤ 100ï¼šåŒæ­¥å¤„ç†ï¼Œç«‹å³è¿”å›ç»“æœ
- æ•°é‡ > 100ï¼šè‡ªåŠ¨å¼‚æ­¥å¤„ç†ï¼Œè¿”å›ä»»åŠ¡ID

**æ‰‹åŠ¨æŒ‡å®šå¼‚æ­¥**ï¼š
```
POST /api/shuangseqiu/fetch-history?count=50&async=true
```

#### 2.3 å¼‚æ­¥æµç¨‹

**æ­¥éª¤1ï¼šåˆ›å»ºä»»åŠ¡**
```http
POST /api/shuangseqiu/fetch-history?count=500

Response:
{
  "code": 0,
  "msg": "ä»»åŠ¡å·²åˆ›å»ºï¼Œè¯·é€šè¿‡ä»»åŠ¡IDæŸ¥è¯¢è¿›åº¦",
  "data": {
    "task_id": "20251029160000abc123"
  }
}
```

**æ­¥éª¤2ï¼šæŸ¥è¯¢è¿›åº¦**
```http
GET /api/task/20251029160000abc123

Response:
{
  "code": 0,
  "msg": "success",
  "data": {
    "id": "20251029160000abc123",
    "type": "shuangseqiu",
    "status": "running",  // æˆ– "completed", "failed"
    "progress": 60,
    "total": 500,
    "success": 300,
    "skipped": 0,
    "failed": 0,
    "message": "",
    "start_time": "2025-10-29T16:00:00Z",
    "end_time": null
  }
}
```

**æ­¥éª¤3ï¼šè·å–ç»“æœ**ï¼ˆä»»åŠ¡å®Œæˆåï¼‰
```http
GET /api/task/20251029160000abc123

Response:
{
  "code": 0,
  "msg": "success",
  "data": {
    "id": "20251029160000abc123",
    "type": "shuangseqiu",
    "status": "completed",
    "progress": 100,
    "total": 500,
    "success": 485,
    "skipped": 15,
    "failed": 0,
    "start_time": "2025-10-29T16:00:00Z",
    "end_time": "2025-10-29T16:05:30Z",
    "result": {
      "total": 500,
      "success": 485,
      "skipped": 15,
      "failed": 0
    }
  }
}
```

### é—®é¢˜3ï¼šå‡å°‘é‡å¤è¯·æ±‚

**è§£å†³æ–¹æ¡ˆ**ï¼šæ™ºèƒ½å¢é‡æ›´æ–°ï¼ˆæä¾›äº†APIï¼Œå‰ç«¯å¯é€‰æ‹©ä½¿ç”¨ï¼‰

æ–°å¢ `GetLatestIssue` æ–¹æ³•ï¼š

```go
// è·å–æ•°æ®åº“ä¸­æœ€æ–°çš„æœŸå·
latestIssue, err := lotteryService.GetLatestIssue("shuangseqiu")

// å‰ç«¯å¯ä»¥æ ¹æ®æœ€æ–°æœŸå·ï¼Œåªè·å–æ›´æ–°çš„æ•°æ®
// ä¾‹å¦‚ï¼šæœ€æ–°æœŸå·æ˜¯2025120ï¼Œåªéœ€è¦è·å–2025121ä¹‹åçš„æ•°æ®
```

**ä½¿ç”¨æµç¨‹**ï¼š
1. å‰ç«¯å…ˆæŸ¥è¯¢æ•°æ®åº“ä¸­å·²æœ‰çš„æœ€æ–°æœŸå·
2. è®¡ç®—éœ€è¦è·å–çš„æœŸæ•°
3. åªè·å–ç¼ºå¤±çš„æ•°æ®

---

## ğŸ“Š èµ°åŠ¿å›¾åŠŸèƒ½

### åŠŸèƒ½ç‰¹ç‚¹

- âœ… é»˜è®¤æ˜¾ç¤ºæœ€è¿‘50æœŸæ•°æ®
- âœ… æ”¯æŒè‡ªå®šä¹‰æœŸæ•°ï¼ˆæœ€å¤š200æœŸï¼‰
- âœ… å·ç å‡ºç°é¢‘ç‡ç»Ÿè®¡
- âœ… å·ç é—æ¼å€¼ç»Ÿè®¡
- âœ… å®Œæ•´çš„å¼€å¥–è®°å½•

### åŒè‰²çƒèµ°åŠ¿æ•°æ®

**æ¥å£**ï¼š`GET /api/shuangseqiu/trend?limit=50`

**è¿”å›æ•°æ®**ï¼š
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "issues": ["2025100", "2025101", "2025102"],
    "red_balls": [
      [1, 5, 12, 18, 25, 33],
      [2, 8, 15, 20, 28, 30],
      [3, 9, 16, 22, 29, 31]
    ],
    "blue_balls": [5, 10, 8],
    "red_freq": {
      "1": 15,   // å·ç 1å‡ºç°äº†15æ¬¡
      "2": 12,
      ...
    },
    "blue_freq": {
      "1": 8,
      "2": 6,
      ...
    },
    "red_missing": {
      "1": 0,    // å·ç 1é—æ¼0æœŸï¼ˆåˆšå‡ºç°ï¼‰
      "2": 5,    // å·ç 2é—æ¼5æœŸï¼ˆ5æœŸæœªå‡ºç°ï¼‰
      ...
    },
    "blue_missing": {
      "1": 3,
      "2": 0,
      ...
    },
    "records": [...]  // å®Œæ•´çš„å¼€å¥–è®°å½•
  }
}
```

### å¤§ä¹é€èµ°åŠ¿æ•°æ®

**æ¥å£**ï¼š`GET /api/daletou/trend?limit=50`

**è¿”å›æ•°æ®**ï¼š
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "issues": ["25100", "25101", "25102"],
    "front_balls": [
      [1, 5, 12, 18, 25],
      [2, 8, 15, 20, 28],
      [3, 9, 16, 22, 29]
    ],
    "back_balls": [
      [3, 8],
      [5, 10],
      [2, 7]
    ],
    "front_freq": {
      "1": 20,
      "2": 18,
      ...
    },
    "back_freq": {
      "1": 12,
      "2": 10,
      ...
    },
    "front_missing": {
      "1": 0,
      "2": 3,
      ...
    },
    "back_missing": {
      "1": 5,
      "2": 0,
      ...
    },
    "records": [...]
  }
}
```

### æ•°æ®ç»Ÿè®¡è¯´æ˜

#### å‡ºç°é¢‘ç‡ï¼ˆFrequencyï¼‰
- **å«ä¹‰**ï¼šå·ç åœ¨ç»Ÿè®¡æœŸæ•°å†…å‡ºç°çš„æ€»æ¬¡æ•°
- **ç”¨é€”**ï¼š
  - è¯†åˆ«çƒ­é—¨å·ç ï¼ˆé«˜é¢‘å·ç ï¼‰
  - è¯†åˆ«å†·é—¨å·ç ï¼ˆä½é¢‘å·ç ï¼‰
  - è¾…åŠ©é€‰å·å‚è€ƒ

#### é—æ¼å€¼ï¼ˆMissingï¼‰
- **å«ä¹‰**ï¼šå·ç è¿ç»­æœªå‡ºç°çš„æœŸæ•°
- **è®¡ç®—æ–¹æ³•**ï¼š
  - å¦‚æœå·ç åœ¨æœ€æ–°ä¸€æœŸå‡ºç°ï¼Œé—æ¼å€¼ä¸º0
  - å¦‚æœå·ç åœ¨æœ€è¿‘NæœŸæœªå‡ºç°ï¼Œé—æ¼å€¼ä¸ºN
- **ç”¨é€”**ï¼š
  - è¯†åˆ«é•¿æœŸæœªå‡ºç°çš„å·ç 
  - é—æ¼å€¼è¾ƒå¤§çš„å·ç å¯èƒ½å³å°†å‡ºç°

---

## ğŸ“¡ APIæ–‡æ¡£

### æ‰¹é‡è·å–å†å²æ•°æ®

#### 1. åŒè‰²çƒæ‰¹é‡è·å–

```http
POST /api/shuangseqiu/fetch-history?count=100&async=false
```

**å‚æ•°**ï¼š
- `count`ï¼šè·å–æœŸæ•°ï¼ˆé»˜è®¤100ï¼Œæœ€å¤§2000ï¼‰
- `async`ï¼šæ˜¯å¦å¼‚æ­¥ï¼ˆtrue/falseï¼Œæ•°é‡>100æ—¶è‡ªåŠ¨å¼‚æ­¥ï¼‰

**åŒæ­¥å“åº”**ï¼ˆcount â‰¤ 100ï¼‰ï¼š
```json
{
  "code": 0,
  "msg": "æ‰¹é‡è·å–å®Œæˆ",
  "data": {
    "total": 100,
    "success": 95,
    "skipped": 5,
    "failed": 0
  }
}
```

**å¼‚æ­¥å“åº”**ï¼ˆcount > 100ï¼‰ï¼š
```json
{
  "code": 0,
  "msg": "ä»»åŠ¡å·²åˆ›å»ºï¼Œè¯·é€šè¿‡ä»»åŠ¡IDæŸ¥è¯¢è¿›åº¦",
  "data": {
    "task_id": "20251029160000abc123"
  }
}
```

#### 2. å¤§ä¹é€æ‰¹é‡è·å–

```http
POST /api/daletou/fetch-history?count=100&async=false
```

å‚æ•°å’Œå“åº”åŒåŒè‰²çƒã€‚

### ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢

```http
GET /api/task/:id
```

**å“åº”**ï¼š
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "id": "20251029160000abc123",
    "type": "shuangseqiu",
    "status": "completed",
    "progress": 100,
    "total": 500,
    "success": 485,
    "skipped": 15,
    "failed": 0,
    "message": "",
    "start_time": "2025-10-29T16:00:00Z",
    "end_time": "2025-10-29T16:05:30Z",
    "result": {...}
  }
}
```

### èµ°åŠ¿å›¾æ•°æ®

#### 1. åŒè‰²çƒèµ°åŠ¿

```http
GET /api/shuangseqiu/trend?limit=50
```

**å‚æ•°**ï¼š
- `limit`ï¼šæœŸæ•°ï¼ˆé»˜è®¤50ï¼Œæœ€å¤§200ï¼‰

#### 2. å¤§ä¹é€èµ°åŠ¿

```http
GET /api/daletou/trend?limit=50
```

**å‚æ•°**ï¼š
- `limit`ï¼šæœŸæ•°ï¼ˆé»˜è®¤50ï¼Œæœ€å¤§200ï¼‰

---

## ğŸ“– ä½¿ç”¨æŒ‡å—

### åç«¯å¯åŠ¨

```bash
cd backend
go run main.go
```

### åœºæ™¯1ï¼šå°æ‰¹é‡åŒæ­¥è·å–

é€‚ç”¨äºè·å–å°‘é‡æ•°æ®ï¼ˆâ‰¤100æœŸï¼‰

```javascript
// å‰ç«¯ä»£ç 
const result = await shuangseqiuAPI.fetchHistory(50)
console.log('æˆåŠŸ:', result.success)
console.log('è·³è¿‡:', result.skipped)
```

### åœºæ™¯2ï¼šå¤§æ‰¹é‡å¼‚æ­¥è·å–

é€‚ç”¨äºè·å–å¤§é‡æ•°æ®ï¼ˆ>100æœŸï¼‰

```javascript
// æ­¥éª¤1ï¼šåˆ›å»ºä»»åŠ¡
const result = await shuangseqiuAPI.fetchHistory(500)
const taskId = result.task_id

// æ­¥éª¤2ï¼šè½®è¯¢æŸ¥è¯¢è¿›åº¦
const checkProgress = setInterval(async () => {
  const task = await taskAPI.getTask(taskId)
  
  console.log('è¿›åº¦:', task.progress + '%')
  console.log('æˆåŠŸ:', task.success)
  console.log('è·³è¿‡:', task.skipped)
  
  if (task.status === 'completed') {
    clearInterval(checkProgress)
    ElMessage.success('è·å–å®Œæˆï¼')
    loadData() // åˆ·æ–°åˆ—è¡¨
  } else if (task.status === 'failed') {
    clearInterval(checkProgress)
    ElMessage.error('è·å–å¤±è´¥ï¼š' + task.message)
  }
}, 2000) // æ¯2ç§’æŸ¥è¯¢ä¸€æ¬¡
```

### åœºæ™¯3ï¼šè·å–èµ°åŠ¿å›¾æ•°æ®

```javascript
// è·å–æœ€è¿‘50æœŸèµ°åŠ¿
const trend = await shuangseqiuAPI.getTrend(50)

// ä½¿ç”¨EChartsæ¸²æŸ“
const option = {
  title: { text: 'åŒè‰²çƒèµ°åŠ¿å›¾' },
  xAxis: {
    type: 'category',
    data: trend.issues  // ['2025100', '2025101', ...]
  },
  yAxis: { type: 'value' },
  series: [
    {
      name: 'çº¢çƒ1',
      type: 'line',
      data: trend.red_balls.map(balls => balls[0])
    },
    // ... å…¶ä»–çº¢çƒ
  ]
}
chart.setOption(option)
```

### åœºæ™¯4ï¼šå·ç é¢‘ç‡åˆ†æ

```javascript
const trend = await shuangseqiuAPI.getTrend(100)

// æ‰¾å‡ºå‡ºç°é¢‘ç‡æœ€é«˜çš„5ä¸ªçº¢çƒ
const sortedRedBalls = Object.entries(trend.red_freq)
  .sort((a, b) => b[1] - a[1])
  .slice(0, 5)

console.log('çƒ­é—¨çº¢çƒ:', sortedRedBalls)
// è¾“å‡º: [[15, 25], [8, 23], [22, 21], ...]

// æ‰¾å‡ºé—æ¼å€¼æœ€å¤§çš„5ä¸ªçº¢çƒ
const sortedMissing = Object.entries(trend.red_missing)
  .sort((a, b) => b[1] - a[1])
  .slice(0, 5)

console.log('é•¿æœŸæœªå‡ºç°:', sortedMissing)
// è¾“å‡º: [[7, 15], [19, 12], [31, 10], ...]
```

---

## ğŸ¨ å‰ç«¯å®ç°å»ºè®®

### 1. ä»»åŠ¡è¿›åº¦æ¡ç»„ä»¶

```vue
<template>
  <el-dialog v-model="showProgress" title="æ•°æ®è·å–ä¸­">
    <el-progress :percentage="progress" />
    <p>æ€»è®¡: {{ task.total }}</p>
    <p>æˆåŠŸ: {{ task.success }}</p>
    <p>è·³è¿‡: {{ task.skipped }}</p>
    <p>å¤±è´¥: {{ task.failed }}</p>
  </el-dialog>
</template>

<script setup>
const showProgress = ref(false)
const task = ref({})
const progress = computed(() => task.value.progress || 0)

const startFetch = async (count) => {
  const result = await shuangseqiuAPI.fetchHistory(count)
  
  if (result.task_id) {
    // å¼‚æ­¥ä»»åŠ¡
    showProgress.value = true
    pollTask(result.task_id)
  } else {
    // åŒæ­¥å®Œæˆ
    ElMessage.success('è·å–å®Œæˆ')
  }
}

const pollTask = (taskId) => {
  const timer = setInterval(async () => {
    const res = await taskAPI.getTask(taskId)
    task.value = res
    
    if (res.status === 'completed' || res.status === 'failed') {
      clearInterval(timer)
      showProgress.value = false
    }
  }, 2000)
}
</script>
```

### 2. èµ°åŠ¿å›¾ç»„ä»¶ï¼ˆä½¿ç”¨EChartsï¼‰

```vue
<template>
  <div>
    <el-select v-model="limit" @change="loadTrend">
      <el-option label="æœ€è¿‘30æœŸ" :value="30" />
      <el-option label="æœ€è¿‘50æœŸ" :value="50" />
      <el-option label="æœ€è¿‘100æœŸ" :value="100" />
    </el-select>
    
    <div ref="chartRef" style="width: 100%; height: 500px"></div>
  </div>
</template>

<script setup>
import * as echarts from 'echarts'

const chartRef = ref()
const limit = ref(50)
let chart

onMounted(() => {
  chart = echarts.init(chartRef.value)
  loadTrend()
})

const loadTrend = async () => {
  const trend = await shuangseqiuAPI.getTrend(limit.value)
  
  const option = {
    title: { text: 'åŒè‰²çƒèµ°åŠ¿å›¾' },
    tooltip: { trigger: 'axis' },
    legend: {
      data: ['çº¢çƒ1', 'çº¢çƒ2', 'çº¢çƒ3', 'çº¢çƒ4', 'çº¢çƒ5', 'çº¢çƒ6', 'è“çƒ']
    },
    xAxis: {
      type: 'category',
      data: trend.issues
    },
    yAxis: { type: 'value', max: 33 },
    series: [
      {
        name: 'çº¢çƒ1',
        type: 'line',
        data: trend.red_balls.map(balls => balls[0]),
        itemStyle: { color: '#f56c6c' }
      },
      // ... å…¶ä»–ç³»åˆ—
    ]
  }
  
  chart.setOption(option)
}
</script>
```

---

## ğŸ”§ æŠ€æœ¯è¦ç‚¹

### 1. å¹¶å‘å®‰å…¨

ä½¿ç”¨ `sync.RWMutex` ä¿æŠ¤ä»»åŠ¡ç®¡ç†å™¨ï¼š
```go
func (tm *TaskManager) UpdateTask(id string, updater func(*TaskInfo)) {
    tm.mutex.Lock()
    defer tm.mutex.Unlock()
    // ...
}
```

### 2. å†…å­˜ç®¡ç†

è‡ªåŠ¨æ¸…ç†è¿‡æœŸä»»åŠ¡ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ï¼š
```go
func (tm *TaskManager) CleanOldTasks() {
    // åˆ é™¤1å°æ—¶å‰å®Œæˆçš„ä»»åŠ¡
}
```

### 3. æ•°æ®ä¸€è‡´æ€§

é—æ¼å€¼è®¡ç®—ä¿è¯å‡†ç¡®æ€§ï¼š
```go
// æ¯æœŸå¤„ç†æ—¶ï¼š
// 1. æ‰€æœ‰å·ç é—æ¼å€¼+1
// 2. å‡ºç°çš„å·ç é—æ¼å€¼å½’é›¶
```

---

## ğŸ“¦ æ–°å¢æ–‡ä»¶

1. `backend/services/task_manager.go` - ä»»åŠ¡ç®¡ç†å™¨
2. `backend/services/trend_service.go` - èµ°åŠ¿å›¾æœåŠ¡
3. ä¿®æ”¹æ–‡ä»¶:
   - `backend/services/lottery_service.go` - æ·»åŠ å¼‚æ­¥æ”¯æŒ
   - `backend/api/handlers.go` - æ·»åŠ æ–°handler
   - `backend/api/routes.go` - æ·»åŠ æ–°è·¯ç”±
   - `backend/main.go` - é›†æˆæ–°æœåŠ¡

---

## ğŸš€ ä¸‹ä¸€æ­¥

å»ºè®®å‰ç«¯å®ç°ï¼š

1. **æ‰¹é‡è·å–ä¼˜åŒ–**
   - æ·»åŠ ä»»åŠ¡è¿›åº¦æ¡
   - å®ç°è½®è¯¢æœºåˆ¶
   - æ·»åŠ å–æ¶ˆåŠŸèƒ½

2. **èµ°åŠ¿å›¾å±•ç¤º**
   - é›†æˆECharts
   - å®ç°å·ç èµ°åŠ¿å›¾
   - å®ç°é¢‘ç‡åˆ†å¸ƒå›¾
   - å®ç°é—æ¼å€¼ç»Ÿè®¡å›¾

3. **æ™ºèƒ½åˆ†æ**
   - çƒ­é—¨å·ç æ¨è
   - å†·é—¨å·ç æé†’
   - é—æ¼å€¼é¢„è­¦

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¼‚æ­¥ä»»åŠ¡**ï¼šå‰ç«¯éœ€è¦å®ç°è½®è¯¢æœºåˆ¶
2. **ä»»åŠ¡æ¸…ç†**ï¼šä»»åŠ¡1å°æ—¶åè‡ªåŠ¨æ¸…ç†
3. **å¹¶å‘é™åˆ¶**ï¼šå»ºè®®é™åˆ¶åŒæ—¶è¿è¡Œçš„ä»»åŠ¡æ•°
4. **æ•°æ®é‡**ï¼šèµ°åŠ¿å›¾æœ€å¤šæ˜¾ç¤º200æœŸæ•°æ®

