# 批量获取历史数据功能说明

## 📋 功能概述

新增批量获取历史数据功能，可以一次性获取双色球和大乐透的历史开奖记录。该功能具有以下特点：

- ✅ 支持批量获取 10-500 期历史数据
- ✅ 自动去重，已存在的数据不重复添加
- ✅ 智能请求频率控制，避免被API限流
- ✅ 实时统计显示（成功、跳过、失败）
- ✅ 详细的日志记录

## 🎯 使用方法

### 1️⃣ **双色球批量获取**

1. 进入双色球页面
2. 点击 **"批量获取历史数据"** 按钮
3. 在对话框中输入要获取的期数（默认100期，最多500期）
4. 点击 **"开始获取"** 按钮
5. 等待获取完成，查看统计结果

### 2️⃣ **大乐透批量获取**

1. 进入大乐透页面
2. 点击 **"批量获取历史数据"** 按钮
3. 在对话框中输入要获取的期数（默认100期，最多500期）
4. 点击 **"开始获取"** 按钮
5. 等待获取完成，查看统计结果

## 🔧 技术实现

### 后端实现

#### 1. **Service层 - 批量获取逻辑**

**双色球批量获取** (`FetchShuangseqiuHistory`):
```go
func (s *LotteryService) FetchShuangseqiuHistory(count int) (*BatchResult, error)
```

- 单次请求获取多期数据（利用官方API的 `issueCount` 参数）
- 每处理10条数据休息1秒，控制处理速度
- 自动解析、验证、保存每期数据
- 遇到已存在的数据自动跳过

**大乐透批量获取** (`FetchDaletouHistory`):
```go
func (s *LotteryService) FetchDaletouHistory(count int) (*BatchResult, error)
```

- 使用分页方式获取数据（每页30条）
- 每页之间休息2秒，避免请求过快
- 每处理10条数据休息0.5秒
- 自动处理两种格式的开奖结果（带`#`分隔符和不带分隔符）

#### 2. **数据去重机制**

利用已有的 `SaveShuangseqiu` 和 `SaveDaletou` 方法：

```go
// 检查期号是否已存在
var existing models.Shuangseqiu
err := db.Where("issue = ?", ssq.Issue).First(&existing).Error
if err == nil {
    // 记录已存在，跳过
    return fmt.Errorf("期号 %s 的数据已存在", ssq.Issue)
}
```

#### 3. **统计结果结构**

```go
type BatchResult struct {
    Total   int `json:"total"`   // 总期数
    Success int `json:"success"` // 成功添加
    Skipped int `json:"skipped"` // 已存在跳过
    Failed  int `json:"failed"`  // 失败
}
```

#### 4. **API路由**

```go
// 双色球批量获取
ssq.POST("/fetch-history", handler.FetchShuangseqiuHistory)

// 大乐透批量获取
dlt.POST("/fetch-history", handler.FetchDaletouHistory)
```

**请求参数**:
- `count` (可选): 获取期数，默认100，最大500

**响应示例**:
```json
{
  "code": 0,
  "msg": "批量获取完成",
  "data": {
    "total": 100,
    "success": 85,
    "skipped": 15,
    "failed": 0
  }
}
```

### 前端实现

#### 1. **API调用**

`frontend/src/api/lottery.js`:
```javascript
// 双色球批量获取
fetchHistory(count = 100) {
  return request.post('/api/shuangseqiu/fetch-history', null, {
    params: { count }
  })
}

// 大乐透批量获取
fetchHistory(count = 100) {
  return request.post('/api/daletou/fetch-history', null, {
    params: { count }
  })
}
```

#### 2. **UI组件**

**批量获取对话框**:
- 期数输入（InputNumber组件，最小10，最大500，步进10）
- 获取按钮（带 loading 状态）
- 结果统计展示（Descriptions组件）

**结果展示**:
- 总计: 显示请求的总期数
- 成功: 绿色标签，显示成功添加的期数
- 跳过: 黄色标签，显示已存在跳过的期数
- 失败: 红色标签，显示失败的期数

#### 3. **用户提示**

```javascript
if (result.success > 0) {
  ElMessage.success(`成功获取 ${result.success} 期数据`)
} else if (result.skipped === result.total) {
  ElMessage.info('所有数据都已存在')
} else {
  ElMessage.warning('批量获取完成，部分数据失败')
}
```

## ⚙️ 请求频率控制

### 双色球
- **单次获取**: 一次API请求获取所有期数
- **处理频率**: 每处理10条数据休息1秒

### 大乐透
- **分页获取**: 每页30条数据
- **页面间隔**: 每页之间休息2秒
- **处理频率**: 每处理10条数据休息0.5秒

### 为什么需要频率控制？

1. **避免被限流**: 官方API可能有请求频率限制
2. **减轻服务器压力**: 避免短时间内大量请求
3. **提高成功率**: 降低被识别为爬虫的风险
4. **友好使用**: 尊重官方API资源

## 📊 使用场景

### 场景1：初次使用系统
```
操作: 获取500期历史数据
结果: 成功500, 跳过0, 失败0
时间: 约1-2分钟
```

### 场景2：定期更新
```
操作: 每周获取10期最新数据
结果: 成功3, 跳过7, 失败0
说明: 7期已存在，新增3期
```

### 场景3：补充缺失数据
```
操作: 获取100期数据
结果: 成功20, 跳过80, 失败0
说明: 系统已有80期，补充了20期缺失数据
```

## 🔍 日志示例

### 双色球批量获取日志
```
2025/10/29 12:00:00 开始批量获取双色球历史数据，共 100 期
2025/10/29 12:00:01 成功获取 100 期双色球数据，开始处理...
2025/10/29 12:00:02 已处理 10/100 期，休息1秒...
2025/10/29 12:00:04 已处理 20/100 期，休息1秒...
...
2025/10/29 12:01:30 双色球批量获取完成: 总计=100, 成功=85, 跳过=15, 失败=0
```

### 大乐透批量获取日志
```
2025/10/29 12:05:00 开始批量获取大乐透历史数据，共 100 期
2025/10/29 12:05:01 正在获取第 1/4 页...
2025/10/29 12:05:02 第 1 页获取到 30 期数据
2025/10/29 12:05:04 休息2秒后继续...
2025/10/29 12:05:06 正在获取第 2/4 页...
...
2025/10/29 12:06:30 大乐透批量获取完成: 总计=100, 成功=90, 跳过=10, 失败=0
```

## ⚠️ 注意事项

1. **网络连接**: 确保服务器可以访问官方API
2. **耐心等待**: 批量获取需要一定时间，请勿中断
3. **期数选择**: 
   - 初次使用建议获取100-200期
   - 日常更新建议获取10-30期
   - 最多不超过500期
4. **重复执行**: 可以重复执行，系统会自动跳过已存在的数据
5. **失败重试**: 如果部分数据失败，可以再次执行批量获取

## 🎨 界面截图说明

### 批量获取按钮
位于页面顶部操作栏，灰色按钮，图标为刷新符号

### 批量获取对话框
- 标题: "批量获取历史数据"
- 输入框: 数字输入框，可以使用加减按钮或直接输入
- 提示文本: "默认100期，最多500期"
- 按钮: "取消" 和 "开始获取"（获取中显示加载动画）

### 结果展示
在对话框下方显示统计表格：
- 总计: 数字
- 成功: 绿色标签
- 跳过: 黄色标签
- 失败: 红色标签

## 🚀 性能优化

1. **单次请求**: 双色球使用单次请求获取所有数据，减少网络开销
2. **批量插入**: 可以考虑使用数据库批量插入（当前逐条插入，保证数据完整性）
3. **并发处理**: 当前串行处理，保证稳定性和防止限流
4. **错误隔离**: 单条数据失败不影响其他数据处理

## 📝 未来改进

- [ ] 添加进度条显示
- [ ] 支持指定期号范围获取
- [ ] 支持导出获取结果
- [ ] 添加获取历史记录
- [ ] 支持后台任务队列
- [ ] 添加定时自动获取

## 🔗 相关文件

### 后端
- `backend/services/lottery_service.go` - 批量获取逻辑
- `backend/api/handlers.go` - HTTP处理器
- `backend/api/routes.go` - 路由注册

### 前端
- `frontend/src/api/lottery.js` - API调用
- `frontend/src/views/Shuangseqiu.vue` - 双色球页面
- `frontend/src/views/Daletou.vue` - 大乐透页面

