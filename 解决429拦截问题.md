# ğŸ›¡ï¸ è§£å†³ 429 è¢«æ‹¦æˆªé—®é¢˜

## ğŸš¨ é—®é¢˜ç°è±¡

```
çŠ¶æ€ç : 429 (Too Many Requests)
é”™è¯¯ä¿¡æ¯: Restricted Access
æ‹¦æˆªæ–¹: Tencent Cloud EdgeOne
åŸå› : The security policy of this website has blocked you from further access
```

## ğŸ” é—®é¢˜åˆ†æ

### ä¸ºä»€ä¹ˆè¢«æ‹¦æˆªï¼Ÿ

è…¾è®¯äº‘ EdgeOne æ˜¯ä¸€ä¸ªå¼ºå¤§çš„è¾¹ç¼˜å®‰å…¨å’ŒåŠ é€ŸæœåŠ¡ï¼Œå®ƒä¼šæ£€æµ‹ï¼š

1. **è¯·æ±‚ç‰¹å¾ä¸å®Œæ•´** âš ï¸
   - ç¼ºå°‘ Refererï¼ˆæ¥æºé¡µé¢ï¼‰
   - ç¼ºå°‘ Originï¼ˆè¯·æ±‚æºï¼‰
   - ç¼ºå°‘æµè§ˆå™¨ç‰¹æœ‰çš„å®‰å…¨å¤´

2. **è¯·æ±‚è¿‡äºé¢‘ç¹** âš ï¸
   - çŸ­æ—¶é—´å†…å¤šæ¬¡è¯·æ±‚
   - æ²¡æœ‰åˆç†çš„é—´éš”

3. **ä¸åƒçœŸå®æµè§ˆå™¨** âš ï¸
   - ç¼ºå°‘ Chrome ç‰¹æœ‰çš„ `sec-ch-ua` å¤´
   - ç¼ºå°‘ `Sec-Fetch-*` å®‰å…¨å¤´

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. æ·»åŠ  Referer å’Œ Origin

è¿™ä¸¤ä¸ªå¤´å‘Šè¯‰æœåŠ¡å™¨"æˆ‘æ˜¯ä»å®˜ç½‘æ¥çš„"ï¼š

```go
// åŒè‰²çƒè¯·æ±‚
SetHeader("Referer", "https://www.cwl.gov.cn/").
SetHeader("Origin", "https://www.cwl.gov.cn")

// å¤§ä¹é€è¯·æ±‚
SetHeader("Referer", "https://www.sporttery.cn/").
SetHeader("Origin", "https://www.sporttery.cn")
```

### 2. æ·»åŠ  Chrome å®‰å…¨å¤´

Chrome æµè§ˆå™¨ä¼šè‡ªåŠ¨å‘é€è¿™äº›å¤´ï¼š

```go
SetHeader("Sec-Fetch-Dest", "empty").          // è¯·æ±‚ç›®æ ‡ç±»å‹
SetHeader("Sec-Fetch-Mode", "cors").           // è¯·æ±‚æ¨¡å¼
SetHeader("Sec-Fetch-Site", "same-origin").    // åŒæºè¯·æ±‚
SetHeader("sec-ch-ua", `"Google Chrome";v="131", "Chromium";v="131", "Not_A Brand";v="24"`).
SetHeader("sec-ch-ua-mobile", "?0").           // éç§»åŠ¨ç«¯
SetHeader("sec-ch-ua-platform", `"macOS"`)     // å¹³å°
```

### 3. æ·»åŠ ç¼“å­˜æ§åˆ¶å¤´

```go
SetHeader("Cache-Control", "no-cache").
SetHeader("Pragma", "no-cache")
```

### 4. å¢åŠ é‡è¯•ç­‰å¾…æ—¶é—´

é¿å…è¢«è¯†åˆ«ä¸ºé¢‘ç¹è¯·æ±‚ï¼š

```go
SetRetryWaitTime(2 * time.Second).      // ä» 1ç§’ å¢åŠ åˆ° 2ç§’
SetRetryMaxWaitTime(10 * time.Second)   // ä» 5ç§’ å¢åŠ åˆ° 10ç§’
```

## ğŸ“Š å®Œæ•´çš„è¯·æ±‚å¤´é…ç½®

### å…¨å±€é…ç½®ï¼ˆæ‰€æœ‰è¯·æ±‚ï¼‰

```go
client := resty.New().
    SetTimeout(30 * time.Second).
    SetRetryCount(3).
    SetRetryWaitTime(2 * time.Second).
    SetRetryMaxWaitTime(10 * time.Second).
    // åŸºç¡€æµè§ˆå™¨å¤´
    SetHeader("User-Agent", "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36").
    SetHeader("Accept", "application/json, text/plain, */*").
    SetHeader("Accept-Language", "zh-CN,zh;q=0.9,en;q=0.8").
    SetHeader("Accept-Encoding", "gzip, deflate, br").
    SetHeader("Connection", "keep-alive").
    // ç¼“å­˜æ§åˆ¶
    SetHeader("Cache-Control", "no-cache").
    SetHeader("Pragma", "no-cache").
    // Chrome å®‰å…¨å¤´
    SetHeader("Sec-Fetch-Dest", "empty").
    SetHeader("Sec-Fetch-Mode", "cors").
    SetHeader("Sec-Fetch-Site", "same-origin").
    SetHeader("sec-ch-ua", `"Google Chrome";v="131", "Chromium";v="131", "Not_A Brand";v="24"`).
    SetHeader("sec-ch-ua-mobile", "?0").
    SetHeader("sec-ch-ua-platform", `"macOS"`)
```

### é’ˆå¯¹æ¯ä¸ªè¯·æ±‚çš„ç‰¹å®šå¤´

```go
// åŒè‰²çƒ
resp, err := s.client.R().
    SetHeader("Referer", "https://www.cwl.gov.cn/").
    SetHeader("Origin", "https://www.cwl.gov.cn").
    SetQueryParams(params).
    Get(s.shuangseqiuURL)

// å¤§ä¹é€
resp, err := s.client.R().
    SetHeader("Referer", "https://www.sporttery.cn/").
    SetHeader("Origin", "https://www.sporttery.cn").
    SetQueryParams(params).
    Get(s.daletouURL)
```

## ğŸ”‘ å…³é”®è¯·æ±‚å¤´è¯´æ˜

### Refererï¼ˆæœ€é‡è¦ï¼‰

```
Referer: https://www.cwl.gov.cn/
```

**ä½œç”¨ï¼š** å‘Šè¯‰æœåŠ¡å™¨è¯·æ±‚æ¥è‡ªå“ªä¸ªé¡µé¢  
**æ•ˆæœï¼š** è®©æœåŠ¡å™¨è®¤ä¸ºä½ æ˜¯ä»å®˜ç½‘ç‚¹å‡»é“¾æ¥è¿‡æ¥çš„

### Originï¼ˆé‡è¦ï¼‰

```
Origin: https://www.cwl.gov.cn
```

**ä½œç”¨ï¼š** è¡¨æ˜è¯·æ±‚çš„æºç«™  
**æ•ˆæœï¼š** ç”¨äº CORS è·¨åŸŸè¯·æ±‚éªŒè¯

### Sec-Fetch-Siteï¼ˆé‡è¦ï¼‰

```
Sec-Fetch-Site: same-origin
```

**ä½œç”¨ï¼š** è¡¨æ˜è¯·æ±‚æ˜¯åŒæºçš„  
**æ•ˆæœï¼š** è®©æœåŠ¡å™¨è®¤ä¸ºè¯·æ±‚æ¥è‡ªç›¸åŒåŸŸå

### sec-ch-uaï¼ˆChrome ç‰¹æœ‰ï¼‰

```
sec-ch-ua: "Google Chrome";v="131", "Chromium";v="131", "Not_A Brand";v="24"
```

**ä½œç”¨ï¼š** Chrome æµè§ˆå™¨çš„å®¢æˆ·ç«¯æç¤º  
**æ•ˆæœï¼š** è¯æ˜ç¡®å®æ˜¯ Chrome æµè§ˆå™¨

## ğŸ¯ å¯¹æ¯”æ•ˆæœ

### ä¹‹å‰ï¼ˆè¢«æ‹¦æˆªï¼‰

```http
GET /api/lottery HTTP/1.1
Host: webapi.sporttery.cn
User-Agent: Mozilla/5.0 ...
Accept: application/json

âŒ ç¼ºå°‘ Referer
âŒ ç¼ºå°‘ Origin
âŒ ç¼ºå°‘ Sec-Fetch-* å¤´
âŒ ç¼ºå°‘ sec-ch-ua å¤´
â†’ ç»“æœï¼š429 è¢«æ‹¦æˆª
```

### ç°åœ¨ï¼ˆå®Œæ•´æ¨¡æ‹Ÿï¼‰

```http
GET /api/lottery HTTP/1.1
Host: webapi.sporttery.cn
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) ...
Accept: application/json, text/plain, */*
Accept-Language: zh-CN,zh;q=0.9,en;q=0.8
Accept-Encoding: gzip, deflate, br
Connection: keep-alive
Cache-Control: no-cache
Pragma: no-cache
Referer: https://www.sporttery.cn/
Origin: https://www.sporttery.cn
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
sec-ch-ua: "Google Chrome";v="131", "Chromium";v="131", "Not_A Brand";v="24"
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: "macOS"

âœ… å®Œæ•´çš„æµè§ˆå™¨å¤´
âœ… æœ‰ Referer æ¥æº
âœ… æœ‰ Chrome ç‰¹å¾
âœ… æ›´åƒçœŸå®æµè§ˆå™¨
â†’ ç»“æœï¼šé€šè¿‡éªŒè¯ âœ…
```

## ğŸš€ å¦‚ä½•ä½¿ç”¨

### 1. é‡å¯åç«¯æœåŠ¡

```bash
# åœæ­¢å½“å‰æœåŠ¡ï¼ˆCtrl+Cï¼‰

# é‡æ–°å¯åŠ¨
cd backend
go run main.go
```

### 2. ç­‰å¾…å‡ åˆ†é’Ÿ

å¦‚æœä¹‹å‰è¢«å°ç¦ï¼Œå¯èƒ½éœ€è¦ç­‰å¾…å‡ åˆ†é’Ÿè®©å°ç¦è¿‡æœŸã€‚

### 3. å†æ¬¡æµ‹è¯•

```bash
# æµ‹è¯•åŒè‰²çƒ
curl -X POST "http://localhost:8080/api/shuangseqiu/fetch"

# æµ‹è¯•å¤§ä¹é€
curl -X POST "http://localhost:8080/api/daletou/fetch"
```

### 4. è§‚å¯Ÿæ—¥å¿—

æŸ¥çœ‹æ˜¯å¦æˆåŠŸï¼š

```
2025/10/29 11:30:00 å¤§ä¹é€APIå“åº”: Success=true, ErrorCode=0, Message=æˆåŠŸ, ListCount=1
2025/10/29 11:30:00 å¤§ä¹é€æ•°æ®è§£ææˆåŠŸ: ...
[GIN] 2025/10/29 - 11:30:00 | 200 | 245.123ms | ::1 | POST "/api/daletou/fetch"
```

## âš ï¸ å¦‚æœè¿˜æ˜¯ 429

### å¯èƒ½çš„åŸå› 

1. **è¯·æ±‚è¿‡äºé¢‘ç¹**
   - ç­‰å¾… 5-10 åˆ†é’Ÿå†è¯•
   - ä¸è¦è¿ç»­å¤šæ¬¡è¯·æ±‚

2. **IP è¢«ä¸´æ—¶å°ç¦**
   - ç­‰å¾…ä¸€æ®µæ—¶é—´
   - è€ƒè™‘ä½¿ç”¨ä»£ç†

3. **API ç­–ç•¥æ›´æ–°**
   - å¯èƒ½éœ€è¦æ›´å¤šéªŒè¯
   - æŸ¥çœ‹å®˜ç½‘æ˜¯å¦æœ‰æ–°çš„è®¿é—®è¦æ±‚

### è°ƒè¯•æ­¥éª¤

1. **åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€å®˜ç½‘**
   - åŒè‰²çƒï¼šhttps://www.cwl.gov.cn
   - å¤§ä¹é€ï¼šhttps://www.sporttery.cn

2. **æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰**
   - åˆ‡æ¢åˆ° Network æ ‡ç­¾
   - åˆ·æ–°é¡µé¢
   - æ‰¾åˆ° API è¯·æ±‚

3. **æŸ¥çœ‹å®é™…çš„è¯·æ±‚å¤´**
   - å¤åˆ¶æ‰€æœ‰è¯·æ±‚å¤´
   - å¯¹æ¯”æˆ‘ä»¬å‘é€çš„
   - æ·»åŠ ç¼ºå¤±çš„å¤´

4. **ä½¿ç”¨ curl æµ‹è¯•**
   ```bash
   curl -v \
     -H "Referer: https://www.sporttery.cn/" \
     -H "User-Agent: Mozilla/5.0 ..." \
     "https://webapi.sporttery.cn/gateway/lottery/getHistoryPageListV1.qry?gameNo=85&..."
   ```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. æ§åˆ¶è¯·æ±‚é¢‘ç‡

```go
// å¯ä»¥åœ¨æœåŠ¡å±‚æ·»åŠ è¯·æ±‚é™æµ
import "time"

var lastRequestTime time.Time
var requestMutex sync.Mutex

func (s *LotteryService) FetchDaletou(issue string) (*models.Daletou, error) {
    // é™åˆ¶è¯·æ±‚é¢‘ç‡ï¼šè‡³å°‘é—´éš” 2 ç§’
    requestMutex.Lock()
    if time.Since(lastRequestTime) < 2*time.Second {
        time.Sleep(2 * time.Second)
    }
    lastRequestTime = time.Now()
    requestMutex.Unlock()
    
    // ç»§ç»­è¯·æ±‚...
}
```

### 2. æ·»åŠ ç¼“å­˜

é¿å…é‡å¤è¯·æ±‚ç›¸åŒçš„æ•°æ®ï¼š

```go
// å…ˆæ£€æŸ¥æ•°æ®åº“æ˜¯å¦å·²æœ‰
existing, err := s.GetShuangseqiuByIssue(issue)
if err == nil && existing != nil {
    return existing, nil  // ç›´æ¥è¿”å›ç¼“å­˜çš„æ•°æ®
}

// æ²¡æœ‰æ‰è¯·æ±‚ API
```

### 3. é”™è¯¯é‡è¯•ç­–ç•¥

```go
// Resty å·²ç»é…ç½®äº†é‡è¯•
SetRetryCount(3).
SetRetryWaitTime(2 * time.Second)

// å¦‚æœæ˜¯ 429ï¼Œå¯ä»¥å¢åŠ é‡è¯•æ¡ä»¶
AddRetryCondition(func(r *resty.Response, err error) bool {
    return r.StatusCode() == 429  // é‡åˆ° 429 æ—¶é‡è¯•
})
```

## ğŸ“š ç›¸å…³èµ„æº

- **è…¾è®¯äº‘ EdgeOne**: https://www.tencentcloud.com/products/teo
- **HTTP 429**: https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/429
- **Sec-Fetch Headers**: https://web.dev/fetch-metadata/

## ğŸ¯ æ€»ç»“

é€šè¿‡æ·»åŠ å®Œæ•´çš„æµè§ˆå™¨è¯·æ±‚å¤´ï¼Œç‰¹åˆ«æ˜¯ï¼š

âœ… **Referer** - æœ€é‡è¦ï¼Œè¡¨æ˜æ¥æº  
âœ… **Origin** - CORS éªŒè¯  
âœ… **Sec-Fetch-*** - Chrome å®‰å…¨å¤´  
âœ… **sec-ch-ua** - Chrome å®¢æˆ·ç«¯æç¤º  
âœ… **å¢åŠ é‡è¯•é—´éš”** - é¿å…é¢‘ç¹è¯·æ±‚  

ç°åœ¨æˆ‘ä»¬çš„è¯·æ±‚æ›´åƒçœŸå®æµè§ˆå™¨ï¼Œé€šè¿‡å®‰å…¨éªŒè¯çš„æ¦‚ç‡å¤§å¤§æé«˜ï¼ğŸ‰

---

**é‡è¦æç¤ºï¼š** 
- éµå®ˆç½‘ç«™çš„ä½¿ç”¨æ¡æ¬¾
- åˆç†æ§åˆ¶è¯·æ±‚é¢‘ç‡
- ä¸è¦è¿›è¡Œæ¶æ„çˆ¬å–
- å°Šé‡æœåŠ¡å™¨èµ„æº

