# 部署说明文档

## 开发环境部署

### 1. 环境准备

#### 后端环境
```bash
# 安装Go 1.25或更高版本
# macOS
brew install go

# Linux (Ubuntu)
wget https://go.dev/dl/go1.25.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.25.linux-amd64.tar.gz
export PATH=$PATH:/usr/local/go/bin

# 验证安装
go version
```

#### 前端环境
```bash
# 安装Node.js (推荐使用nvm)
# macOS/Linux
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install 18
nvm use 18

# 验证安装
node -v
npm -v
```

### 2. 项目启动

#### 快速启动（推荐）

```bash
# 1. 克隆或下载项目
cd /path/to/caipiao

# 2. 启动后端（新终端窗口）
./start-backend.sh

# 3. 启动前端（新终端窗口）
./start-frontend.sh

# 4. 访问应用
# 浏览器打开: http://localhost:5173
```

#### 手动启动

**启动后端:**
```bash
cd backend
go mod download
go mod tidy
go run main.go
```

**启动前端:**
```bash
cd frontend
npm install
npm run dev
```

---

## 生产环境部署

### 方式一：直接部署

#### 1. 构建后端

```bash
cd backend

# Linux
GOOS=linux GOARCH=amd64 go build -o lottery-server main.go

# Windows
GOOS=windows GOARCH=amd64 go build -o lottery-server.exe main.go

# macOS
GOOS=darwin GOARCH=amd64 go build -o lottery-server main.go
```

#### 2. 构建前端

```bash
cd frontend
npm install
npm run build

# 构建产物在 dist/ 目录
```

#### 3. 部署

**后端部署:**
```bash
# 1. 上传 lottery-server 到服务器
# 2. 创建数据目录
mkdir -p data

# 3. 使用systemd管理服务（Linux）
sudo nano /etc/systemd/system/lottery.service
```

`lottery.service` 内容:
```ini
[Unit]
Description=Lottery Management System Backend
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/path/to/lottery
ExecStart=/path/to/lottery/lottery-server
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务:
```bash
sudo systemctl daemon-reload
sudo systemctl enable lottery
sudo systemctl start lottery
sudo systemctl status lottery
```

**前端部署:**

使用Nginx作为Web服务器:

```nginx
# /etc/nginx/sites-available/lottery
server {
    listen 80;
    server_name your-domain.com;
    
    # 前端静态文件
    root /path/to/lottery/frontend/dist;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API代理
    location /api {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

启用站点:
```bash
sudo ln -s /etc/nginx/sites-available/lottery /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 方式二：Docker部署

#### 1. 创建Dockerfile

**后端Dockerfile (`backend/Dockerfile`):**
```dockerfile
FROM golang:1.25-alpine AS builder

WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=1 GOOS=linux go build -o lottery-server main.go

FROM alpine:latest
RUN apk --no-cache add ca-certificates sqlite
WORKDIR /root/
COPY --from=builder /app/lottery-server .
RUN mkdir -p data

EXPOSE 8080
CMD ["./lottery-server"]
```

**前端Dockerfile (`frontend/Dockerfile`):**
```dockerfile
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

**前端Nginx配置 (`frontend/nginx.conf`):**
```nginx
server {
    listen 80;
    server_name localhost;
    
    root /usr/share/nginx/html;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    location /api {
        proxy_pass http://backend:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

#### 2. Docker Compose配置

创建 `docker-compose.yml`:
```yaml
version: '3.8'

services:
  backend:
    build: ./backend
    container_name: lottery-backend
    restart: always
    ports:
      - "8080:8080"
    volumes:
      - ./data:/root/data
    networks:
      - lottery-network

  frontend:
    build: ./frontend
    container_name: lottery-frontend
    restart: always
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - lottery-network

networks:
  lottery-network:
    driver: bridge

volumes:
  lottery-data:
```

#### 3. 使用Docker部署

```bash
# 构建并启动
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down

# 重启服务
docker-compose restart
```

---

## 配置说明

### 生产环境配置修改

#### 后端配置 (`backend/config/config.go`)

```go
func GetConfig() *Config {
    // 检测环境变量
    env := os.Getenv("APP_ENV")
    if env == "" {
        env = "development"
    }

    config := &Config{
        Server: ServerConfig{
            Port: getEnv("SERVER_PORT", "8080"),
            Mode: "release", // 生产环境使用release模式
        },
        Database: DatabaseConfig{
            Path: getEnv("DB_PATH", "./data/lottery.db"),
        },
        API: APIConfig{
            BaseURL: getEnv("API_BASE_URL", "https://api.example.com"),
        },
    }

    return config
}

func getEnv(key, defaultValue string) string {
    if value := os.Getenv(key); value != "" {
        return value
    }
    return defaultValue
}
```

#### 前端配置

修改 `frontend/src/api/request.js`:
```javascript
const request = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || '',
  timeout: 10000
})
```

创建 `.env.production`:
```
VITE_API_BASE_URL=https://your-api-domain.com
```

---

## 性能优化

### 1. 后端优化

```go
// 添加缓存（使用redis或内存缓存）
// 数据库连接池配置
sqlDB, _ := db.DB()
sqlDB.SetMaxIdleConns(10)
sqlDB.SetMaxOpenConns(100)
sqlDB.SetConnMaxLifetime(time.Hour)

// 添加索引
db.Exec("CREATE INDEX idx_issue ON shuangseqiu(issue)")
db.Exec("CREATE INDEX idx_draw_date ON shuangseqiu(draw_date)")
```

### 2. 前端优化

- 开启Gzip压缩
- 使用CDN加载Element Plus
- 路由懒加载（已实现）
- 图片压缩优化

### 3. Nginx优化

```nginx
# 开启Gzip
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript 
           application/x-javascript application/xml+rss 
           application/json application/javascript;

# 静态文件缓存
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

---

## 监控和日志

### 1. 应用日志

**后端日志:**
```bash
# 使用日志文件
./lottery-server >> /var/log/lottery/app.log 2>&1

# 日志切割
sudo apt install logrotate
```

**日志切割配置:**
```
/var/log/lottery/app.log {
    daily
    rotate 7
    compress
    delaycompress
    notifempty
    create 0644 www-data www-data
}
```

### 2. 系统监控

使用 Prometheus + Grafana 监控系统性能。

---

## 备份策略

### 数据库备份

```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/backup/lottery"
DATE=$(date +%Y%m%d_%H%M%S)
DB_FILE="/path/to/data/lottery.db"

# 创建备份
mkdir -p $BACKUP_DIR
cp $DB_FILE "$BACKUP_DIR/lottery_$DATE.db"

# 保留最近7天的备份
find $BACKUP_DIR -name "lottery_*.db" -mtime +7 -delete
```

添加到crontab:
```bash
# 每天凌晨2点备份
0 2 * * * /path/to/backup.sh
```

---

## 安全建议

1. **使用HTTPS**: 配置SSL证书
2. **防火墙**: 只开放必要端口
3. **限流**: 使用Nginx限制API访问频率
4. **认证**: 添加API认证机制
5. **数据验证**: 严格验证用户输入
6. **定期更新**: 及时更新依赖包

---

## 故障排查

### 常见问题

1. **端口被占用**
```bash
# 查看端口占用
lsof -i :8080
netstat -tlnp | grep 8080

# 杀死进程
kill -9 <PID>
```

2. **数据库锁定**
```bash
# SQLite数据库被锁定
rm -f data/lottery.db-wal
rm -f data/lottery.db-shm
```

3. **内存不足**
```bash
# 查看内存使用
free -h
top

# 清理缓存
sync; echo 3 > /proc/sys/vm/drop_caches
```

---

## 联系支持

如遇到部署问题，请检查：
1. 系统日志
2. 应用日志
3. 网络连接
4. 配置文件

需要帮助请提交Issue。

